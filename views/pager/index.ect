<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v4.min.js"></script>

    <style>
        body {
            background: #eee;

            font-family: 'Helvetica Neue', sans-serif;
            font-size: 14pt;
            font-weight: 300;

            margin: 5vw;
            text-align: center;
        }

        .page {
            background: #fff;
            border: solid 1px #ddd;

            display: inline-block;
            overflow: hidden;
        }

        .page__layers {

        }

        .page__layers__layer {

        }

        .page__layers__layer_hidden {
            display: none;
        }

        .page__layers__layer_artboard {

        }

        .page__layers__layer_transition {
            cursor: pointer;
        }

        .page__layers__layer__children { }

        .page__layers__layer__children {
            position: relative;
        }

        .page__layers__layer__children__layer {
            background-color: #fff;

            position: absolute;
        }
    </style>
</head>

<body>
    <script>
        var snapshot = <%- JSON.stringify(@document) %>;

        var isFirstArtboardProcessed = false;

        var getArtboardNavigationClass = function(index) {
            return 'page__layers__layer_artboard-' + index;
        };

        var renderLayer = function(layer, i) {
            d3.select(this)
                .classed('page__layers__layer_artboard', layer.type === 'artboard')
                .classed(getArtboardNavigationClass(i), layer.type === 'artboard')
                .classed('page__layers__layer_hidden', layer.type === 'artboard' && isFirstArtboardProcessed)
                .style('width', layer.frame.width + 'px')
                .style('height', layer.frame.height + 'px');

            if (layer.type === 'artboard') {
                isFirstArtboardProcessed = true;
            }

            if (layer.type !== 'artboard') {
                d3.select(this)
                    .style('top', layer.frame.y + 'px')
                    .style('left', layer.frame.x + 'px');
            }

            if (layer.type === 'image' || layer.type === 'shape' || layer.type === 'text') {
                d3.select(this)
                    .append('img')
                    .attr('src', layer.image);
            }

            if (layer.children !== undefined) {
                d3.select(this)
                    .append('div')
                    .classed('page__layers__layer__children', true)
                    .selectAll('.page__layers__layer__children__layer')
                    .data(layer.children)
                    .enter()
                    .append('div')
                    .classed('page__layers__layer__children__layer', true)
                    .each(renderLayer);
            }

            if (layer.transition !== undefined) {
                d3.select(this)
                    .classed('page__layers__layer_transition', true)
                    .on('click', function() {
                        var artboard = d3.select(this);

                        while (!artboard.classed('page__layers__layer_artboard')) {
                            artboard = d3.select(artboard.node().parentNode);
                        }

                        artboard.classed('page__layers__layer_hidden', true);

                        d3.select('.' + getArtboardNavigationClass(layer.transition))
                            .classed('page__layers__layer_hidden', false);
                    });
            }
        };

        var renderPage = function(page) {
            d3.select(this)
                .append('div')
                .classed('page__layers', true)
                .selectAll('.page__layers__layer')
                .data(page.layers)
                .enter()
                .append('div')
                .classed('page__layers__layer', true)
                .each(renderLayer);
        };

        var renderSnapshot = function(snapshot) {
            d3.select('body')
                .selectAll('.page')
                .data(snapshot.pages)
                .enter()
                .append('div')
                .classed('page', true)
                .each(renderPage);
        };

        renderSnapshot(snapshot);
    </script>
</body>

</html>